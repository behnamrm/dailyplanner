<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>45-Min Task Tracker</title>
    <!-- PWA manifest is removed as it requires a server -->
    <meta name="theme-color" content="#4f46e5" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#4f46e5', // indigo-600
              secondary: '#10b981', // emerald-500
              light: '#f8fafc', // slate-50
              dark: '#0f172a', // slate-950
            }
          }
        }
      }
    </script>
    <script>
      // On page load or when changing themes, best to add inline in `head` to avoid FOUC
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark')
      } else {
        document.documentElement.classList.remove('dark')
      }
    </script>
    <!-- Add Babel Standalone to transpile JSX/TSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone@7.24.9/babel.min.js"></script>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/",
    "recharts": "https://esm.sh/recharts@^3.1.0",
    "recharts/": "https://esm.sh/recharts@^3.1.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-light dark:bg-dark antialiased">
    <div id="root"></div>
    <!-- 
      All application code is now inlined here.
      type="text/babel" tells Babel to transpile this block.
      data-type="module" enables ES module features like `import`.
    -->
    <script type="text/babel" data-type="module">
      import React, { useState, useCallback, useMemo, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { ResponsiveContainer, BarChart, CartesianGrid, XAxis, YAxis, Tooltip, Legend, Bar } from 'recharts';

      // --- Inlined from hooks/useLocalStorage.ts ---
      function useLocalStorage(key, initialValue) {
        const [storedValue, setStoredValue] = useState(() => {
          if (typeof window === 'undefined') {
            return initialValue;
          }
          try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
          } catch (error) {
            console.error(error);
            return initialValue;
          }
        });

        const setValue = (value) => {
          try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            if (typeof window !== 'undefined') {
              window.localStorage.setItem(key, JSON.stringify(valueToStore));
            }
          } catch (error) {
            console.error(error);
          }
        };

        return [storedValue, setValue];
      }

      // --- Inlined from services/statsService.ts ---
      const getFormattedDateForStats = (date) => {
        return date.toISOString().split('T')[0];
      };

      const calculateStats = (progress, tasks, range) => {
        const endDate = new Date();
        const startDate = new Date();

        switch (range) {
          case '1M':
            startDate.setMonth(startDate.getMonth() - 1);
            break;
          case '3M':
            startDate.setMonth(startDate.getMonth() - 3);
            break;
          case '6M':
            startDate.setMonth(startDate.getMonth() - 6);
            break;
          case '1Y':
            startDate.setFullYear(startDate.getFullYear() - 1);
            break;
        }
        
        const aggregatedData = {};
        tasks.forEach(task => aggregatedData[task.id] = 0);

        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          const dateStr = getFormattedDateForStats(new Date(d));
          if (progress[dateStr]) {
            Object.entries(progress[dateStr]).forEach(([taskId, completions]) => {
              if (aggregatedData[taskId] !== undefined) {
                aggregatedData[taskId] += completions;
              }
            });
          }
        }

        return tasks.map(task => ({
          name: task.name,
          completions: aggregatedData[task.id] || 0,
        })).sort((a, b) => b.completions - a.completions);
      };

      // --- Inlined from components/TaskItem.tsx ---
      const Checkbox = ({ checked, onClick }) => {
        return (
          <button onClick={onClick} className="p-1 focus:outline-none focus:ring-2 focus:ring-primary rounded-md">
            {checked ? (
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-secondary" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
              </svg>
            ) : (
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-slate-300 dark:text-slate-600 hover:text-slate-400 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            )}
          </button>
        );
      };

      const TaskItem = ({ task, completedCount, onUpdate }) => {
        const handleCheckboxClick = (index) => {
          const newCount = index + 1 === completedCount ? index : index + 1;
          onUpdate(newCount);
        };

        return (
          <div className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-center justify-between gap-4">
            <h3 className="text-lg font-medium text-slate-800 dark:text-slate-200 text-center sm:text-left">{task.name}</h3>
            <div className="flex items-center space-x-1 sm:space-x-2">
              {[...Array(5)].map((_, i) => (
                <Checkbox 
                  key={i} 
                  checked={i < completedCount}
                  onClick={() => handleCheckboxClick(i)}
                />
              ))}
            </div>
          </div>
        );
      };

      // --- Inlined from components/AddTaskForm.tsx ---
      const AddTaskForm = ({ onAddTask }) => {
        const [taskName, setTaskName] = useState('');

        const handleSubmit = (e) => {
          e.preventDefault();
          onAddTask(taskName);
          setTaskName('');
        };

        return (
          <div className="p-4 sm:p-6 bg-white dark:bg-slate-800 rounded-lg shadow-lg">
            <h2 className="text-xl font-bold text-slate-700 dark:text-slate-200 mb-2">
              Add New Task
            </h2>
            <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">
              Define a new goal to track in 45-minute sessions.
            </p>
            <form onSubmit={handleSubmit} className="flex gap-2 md:gap-4">
              <input
                type="text"
                value={taskName}
                onChange={(e) => setTaskName(e.target.value)}
                placeholder="e.g., Learn React"
                className="flex-grow bg-slate-100 dark:bg-slate-700 border-2 border-transparent rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition"
                aria-label="New task name"
              />
              <button 
                type="submit"
                className="bg-primary text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors duration-200 disabled:bg-slate-400 disabled:cursor-not-allowed"
                disabled={!taskName.trim()}
                aria-label="Add new task"
              >
                Add
              </button>
            </form>
          </div>
        );
      };

      // --- Inlined from components/DataManagement.tsx ---
      const DataManagement = ({ tasks, progress, onImport }) => {
        const fileInputRef = useRef(null);

        const handleExport = () => {
          const data = { tasks, progress };
          const jsonString = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(data, null, 2))}`;
          const link = document.createElement('a');
          link.href = jsonString;
          const date = new Date().toISOString().split('T')[0];
          link.download = `task-tracker-backup-${date}.json`;
          link.click();
        };

        const handleImportClick = () => {
          fileInputRef.current?.click();
        };

        const handleFileChange = (event) => {
          const file = event.target.files?.[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const text = e.target?.result;
              if (typeof text !== 'string') throw new Error('File could not be read.');
              const importedData = JSON.parse(text);
              if (importedData && Array.isArray(importedData.tasks) && typeof importedData.progress === 'object' && importedData.progress !== null) {
                onImport(importedData);
              } else {
                alert('Error: Invalid backup file format.');
              }
            } catch (error) {
              console.error('Failed to parse backup file:', error);
              alert('Error: Could not import backup. The file may be corrupt or not a valid JSON.');
            }
          };
          reader.onerror = () => alert('Error: Failed to read the file.');
          reader.readAsText(file);
          event.target.value = '';
        };

        const exportButtonClasses = "bg-primary text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors duration-200 disabled:bg-slate-400 disabled:cursor-not-allowed";
        const importButtonClasses = "bg-secondary text-white font-bold py-2 px-4 rounded-md hover:bg-emerald-600 transition-colors duration-200";

        return (
          <div className="p-4 sm:p-6 bg-white dark:bg-slate-800 rounded-lg shadow-lg">
            <h2 className="text-xl font-bold text-slate-700 dark:text-slate-200 mb-2">Backup &amp; Restore</h2>
            <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">Save your tasks and progress to a file, or restore from a backup.</p>
            <div className="flex flex-col sm:flex-row gap-4">
              <button onClick={handleExport} className={exportButtonClasses} disabled={tasks.length === 0 && Object.keys(progress).length === 0} aria-label="Export all tasks and progress to a file">
                Export Backup
              </button>
              <button onClick={handleImportClick} className={importButtonClasses} aria-label="Import tasks and progress from a backup file">
                Import Backup
              </button>
              <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".json,application/json" className="hidden" aria-hidden="true" />
            </div>
          </div>
        );
      };

      // --- Inlined from components/StatsView.tsx ---
      const StatRangeSelector = ({ selectedRange, onSelect }) => {
          const ranges = ['1M', '3M', '6M', '1Y'];
          const buttonBaseClasses = "py-2 px-4 text-sm font-semibold rounded-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-light dark:focus:ring-offset-dark focus:ring-primary";
          const activeClasses = "bg-primary text-white shadow";
          const inactiveClasses = "bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600";

          return (
              <div className="flex justify-center space-x-2 p-2 bg-slate-200 dark:bg-slate-900 rounded-lg">
                  {ranges.map(range => (
                      <button
                          key={range}
                          onClick={() => onSelect(range)}
                          className={`${buttonBaseClasses} ${selectedRange === range ? activeClasses : inactiveClasses}`}
                      >
                          {range === '1Y' ? '1 Year' : `${range.replace('M', '')} Months`}
                      </button>
                  ))}
              </div>
          );
      };

      const CustomTooltip = ({ active, payload, label }) => {
        if (active && payload && payload.length) {
          return (
            <div className="p-3 bg-slate-900 border border-slate-700 rounded-lg shadow-xl text-slate-100">
              <p className="font-bold text-primary mb-1">{`${label}`}</p>
              <p className="text-sm">{`${payload[0].name}: ${payload[0].value}`}</p>
            </div>
          );
        }
        return null;
      };

      const StatsView = ({ tasks, progress }) => {
        const [range, setRange] = useState('1M');
        const statData = useMemo(() => calculateStats(progress, tasks, range), [progress, tasks, range]);
        const totalCompletions = useMemo(() => statData.reduce((sum, item) => sum + item.completions, 0), [statData]);

        return (
          <div className="bg-white dark:bg-slate-800 p-4 sm:p-6 rounded-lg shadow-lg space-y-6">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
              <div>
                <h2 className="text-2xl font-bold text-primary">Your Progress</h2>
                <p className="text-slate-500 dark:text-slate-400 mt-1">Total of {totalCompletions} 45-minute sessions completed.</p>
              </div>
              <StatRangeSelector selectedRange={range} onSelect={setRange} />
            </div>
            {statData.length > 0 && totalCompletions > 0 ? (
              <div className="w-full h-[400px]">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={statData} margin={{ top: 5, right: 20, left: -10, bottom: 20 }} layout="vertical" barCategoryGap="20%">
                    <CartesianGrid strokeDasharray="3 3" stroke="rgba(128, 128, 128, 0.2)" />
                    <XAxis type="number" allowDecimals={false} stroke="rgb(100 116 139)" tick={{ fill: 'rgb(100 116 139)' }} />
                    <YAxis type="category" dataKey="name" width={120} stroke="rgb(100 116 139)" tick={{ fill: 'rgb(156 163 175)'}} />
                    <Tooltip cursor={{ fill: 'rgba(79, 70, 229, 0.1)' }} content={<CustomTooltip />} />
                    <Legend wrapperStyle={{ paddingTop: '20px' }} />
                    <Bar dataKey="completions" fill="#4f46e5" name="Completed Sessions" radius={[0, 4, 4, 0]} />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            ) : (
              <div className="text-center py-16">
                <p className="text-slate-500 dark:text-slate-400">No data available for this period. Keep tracking your tasks!</p>
              </div>
            )}
          </div>
        );
      };

      // --- Inlined from components/Header.tsx ---
      const Header = ({ currentView, setView }) => {
        const buttonBaseClasses = "py-2 px-6 rounded-md font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-light dark:focus:ring-offset-dark focus:ring-primary";
        const activeClasses = "bg-primary text-white shadow-lg";
        const inactiveClasses = "bg-white dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600";

        return (
          <nav className="bg-slate-200 dark:bg-slate-800 p-2 rounded-lg flex justify-center space-x-2 md:space-x-4">
            <button onClick={() => setView('daily')} className={`${buttonBaseClasses} ${currentView === 'daily' ? activeClasses : inactiveClasses}`}>Daily</button>
            <button onClick={() => setView('stats')} className={`${buttonBaseClasses} ${currentView === 'stats' ? activeClasses : inactiveClasses}`}>Statistics</button>
          </nav>
        );
      };

      // --- Inlined from components/DailyView.tsx ---
      const getFormattedDateForDailyView = (date) => {
        return date.toISOString().split('T')[0];
      };

      const DailyView = ({ tasks, progress, onUpdateProgress }) => {
        const today = getFormattedDateForDailyView(new Date());
        const todaysProgress = progress[today] || {};
        const todayFormatted = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        return (
          <div className="space-y-6">
            <div className="p-4 bg-white dark:bg-slate-800 rounded-lg shadow">
              <h2 className="text-2xl font-bold text-primary">{todayFormatted}</h2>
              <p className="text-slate-500 dark:text-slate-400">Your tasks for today. Let's make it productive!</p>
            </div>
            {tasks.length > 0 ? (
              <div className="space-y-4">
                {tasks.map(task => (
                  <TaskItem key={task.id} task={task} completedCount={todaysProgress[task.id] || 0} onUpdate={(newCount) => onUpdateProgress(task.id, newCount)} />
                ))}
              </div>
            ) : (
              <div className="text-center py-10 px-4 bg-white dark:bg-slate-800 rounded-lg shadow">
                <p className="text-slate-500 dark:text-slate-400">No tasks yet. Add one to get started!</p>
              </div>
            )}
          </div>
        );
      };

      // --- Inlined from App.tsx ---
      const getFormattedDateForApp = (date) => {
        return date.toISOString().split('T')[0];
      };

      const App = () => {
        const [view, setView] = useState('daily');
        const [tasks, setTasks] = useLocalStorage('tasks', []);
        const [progress, setProgress] = useLocalStorage('progress', {});

        const handleAddTask = useCallback((taskName) => {
          if (taskName.trim() === '') return;
          const newTask = { id: `task-${Date.now()}`, name: taskName.trim() };
          setTasks(prevTasks => [...prevTasks, newTask]);
        }, [setTasks]);

        const handleUpdateProgress = useCallback((taskId, newCount) => {
          const today = getFormattedDateForApp(new Date());
          setProgress(prevProgress => {
            const newProgress = { ...prevProgress };
            if (!newProgress[today]) {
              newProgress[today] = {};
            }
            newProgress[today][taskId] = newCount;
            return newProgress;
          });
        }, [setProgress]);

        const handleImport = useCallback((data) => {
          if (window.confirm('Are you sure you want to import this backup? This will overwrite all current tasks and progress.')) {
            setTasks(data.tasks);
            setProgress(data.progress);
            alert('Data imported successfully!');
            setView('daily');
          }
        }, [setTasks, setProgress, setView]);

        return (
          <div className="min-h-screen bg-light dark:bg-dark text-dark dark:text-light font-sans">
            <div className="container mx-auto p-4 md:p-8 max-w-6xl">
              <header className="text-center mb-8">
                <h1 className="text-4xl md:text-5xl font-bold text-primary">Task Tracker</h1>
                <p className="text-slate-500 dark:text-slate-400 mt-2">Commit to your 45-minute goals, one block at a time.</p>
              </header>
              <Header currentView={view} setView={setView} />
              <div className="mt-8 lg:grid lg:grid-cols-3 lg:gap-8">
                <main className="lg:col-span-2">
                  {view === 'daily' ? (
                    <DailyView tasks={tasks} progress={progress} onUpdateProgress={handleUpdateProgress} />
                  ) : (
                    <StatsView tasks={tasks} progress={progress} />
                  )}
                </main>
                <aside className="mt-8 space-y-8 lg:mt-0 lg:col-span-1">
                  {view === 'daily' && <AddTaskForm onAddTask={handleAddTask} />}
                  <DataManagement tasks={tasks} progress={progress} onImport={handleImport} />
                </aside>
              </div>
            </div>
          </div>
        );
      };

      // --- Inlined from index.tsx ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }
      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>